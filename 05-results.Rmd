
# Results
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(GGally)
library(gridExtra)
library(highcharter)
library(MASS)
library(parcoords)
library(plotly)
library(readr)
library(scales)
library(stringr)
library(tidyverse)
library(usdata)
library(statebins)
library(usmap)
library(dplyr)
library(socviz)
library(ggrepel)
library(ggthemes)
library(grid)
library(lubridate)
library(tidytext)
library(mapdata)
#library(devtools)
#devtools::install_github("lchiffon/wordcloud2")
library(wordcloud2)
library(jsonlite)
library(RColorBrewer)
```

## Related Factors Affecting Happiness Score

### Overview of one baseline year

We've chosen 2018 as our baseline year for this analysis since it's a normal year before COVID-19. In accordance with the missing value chapter, we've removed some variables.
```{r}
library(corrplot)
data2018 <- read.csv("2018_Sample.csv")
corr_data_2018 <- data2018[,3:14] 
colnames(corr_data_2018) <- c("Life Ladder","GDP","Social Supp","Life Exp","Freedom","Generosity","Perc Corrup","Positive","Negative","Conf Gov","Democratic","Delivery")
M<-cor(na.omit(corr_data_2018))
corrplot(M, type="upper", tl.col="black", tl.srt=45)
```
Focusing on the first line of this correlation matrix plot that shows correlations between life ladder and all other variables, we can observe high positive correlation with GDP, social support, life expectancy, democratic and delivery. Moderate negative correlations are present between life ladder and perception of corruption as well as negative affects, which is reasonable since these are considered as adversity to happiness. Almost all directions make sense except for confidence of government, the magnitude of which is trivial however. 

### Beta Comparison

To further study if importance of these factors change over time, we plot the value of standardized beta coefficients from running regression of life ladder on all the variables. To this end, we selected seven variables that are present for most countries throughout the years.
```{r}
GDP_b <- list()
social_support_b <- list()
expect_b <- list()
freedom_b <- list()
generosity_b <- list()
percp_corrup_b <- list()
pos_affect <- list()
nega_affect <- list()

complete2021 <- read.csv("2021.csv")
colnames(complete2021)[1] <- "Country"
for (x in (2008:2020)) {
  data <- complete2021 %>% filter(year==x)
  num_data <- select(data,c("Life.Ladder","Log.GDP.per.capita","Social.support","Healthy.life.expectancy.at.birth","Freedom.to.make.life.choices"                           ,"Generosity","Perceptions.of.corruption","Positive.affect","Negative.affect"))
  data_std <- data.frame(scale(num_data))
  lm_std <- lm(Life.Ladder ~  Log.GDP.per.capita+ Social.support+Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+Generosity+Perceptions.of.corruption+
       Positive.affect+Negative.affect, data=data_std)
  GDP_b <- append(GDP_b,summary(lm_std)$coefficients[2])
  social_support_b <- append(social_support_b,summary(lm_std)$coefficients[3])
  expect_b <- append(expect_b,summary(lm_std)$coefficients[4])
  freedom_b <- append(freedom_b,summary(lm_std)$coefficients[5])
  generosity_b <- append(generosity_b,summary(lm_std)$coefficients[6])
  percp_corrup_b <- append(percp_corrup_b,summary(lm_std)$coefficients[7])
  pos_affect <- append(pos_affect,summary(lm_std)$coefficients[8])
  nega_affect <- append(nega_affect,summary(lm_std)$coefficients[9])
}
year_list<-list(2008:2020)
beta_df <- data.frame(unlist(year_list), unlist(GDP_b),unlist(social_support_b),unlist(pos_affect),unlist(freedom_b),unlist(generosity_b),unlist(percp_corrup_b),unlist(nega_affect))
names(beta_df) <- c("year","LogGDP","SocialSupp","Positive","Freedom","Generosity","PercepCorrup","Negative")

#betaplot
library(dygraphs)
dygraph(beta_df,main='Standardized Beta, 2008-2020 <small>from regressing life ladder on all variables</small>') %>%
  dyLegend(show = "always", hideOnMouseOut = TRUE,width=700) %>%
  dyAxis("x", label = "Year", valueRange = c(2008, 2020)) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Dark2"))

```

Hover your cursor over the lines to explore the values at different years. 
## General Happiness Score Distribution

### Distribution by Country

### Distribution by Region

### Distribution by Time

Will be discussed in Chapter 6, the Interactive Component.



## COVID-19 Impact on Happiness Score
```{r}
ave1719 <- read.csv("17_19_sample.csv")
averaged <- ave1719 %>% group_by(Country.name)  %>% summarise(score_1719 = mean(Life.Ladder)) %>% ungroup()

score_2020 <- read.csv("2020_sample.csv")

temp_col <- score_2020$Life.Ladder[match(averaged$Country.name, score_2020$Country.name)]
averaged$score_2020 <- temp_col

averaged$difference <- ifelse(!is.na(averaged$score_2020), averaged$score_2020-averaged$score_1719, NA)

averaged <- averaged %>% arrange(desc(averaged$difference))
averaged <- subset(averaged, !is.na(averaged$difference))
averaged <- averaged %>% rename(region = Country.name)
```
### Comparison between Time (Pre and Post Pandemic)
We decide to use data averaged from 2017 to 2019 to represent the general life happiness score before the COVID-19 pandemic, and compare it to the 2020 happiness score. The difference between happiness score is the following:

```{r, fig.height=10, fig.width=15}
theme_dotplot <- theme_bw(14) +
    theme(axis.text.y = element_text(size = rel(.75)),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(.75)),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.x = element_blank())

ggplot(averaged, aes(x = difference, y = reorder(region, difference)))+
    geom_point(color = "red") +
    xlab("Happiness Score Difference") +
    theme_dotplot +
    ylab("Country Name") +
    ggtitle("Happiness Score Difference by Post-Pre Pandemic")
```

```{r, fig.height=10, fig.width=15}
mapdata <- map_data("world")
mapdata$region <- replace(mapdata$region, mapdata$region == "USA", "United States")
mapdata <- left_join(mapdata, averaged, by="region")
mapdata <- mapdata %>% filter(lat > -65)
difference_map <- ggplot(mapdata, aes(x = long, y = lat, group = group)) + geom_polygon(aes(fill = difference)) + scale_fill_gradient(name = "Difference", low = "red", high = "green")
difference_map
```

### Comparison between Region

```{r, fig.height=10, fig.width=15}
geo_covid <- ave1719 %>% group_by(Region) %>% summarise(pre_covid = mean(Life.Ladder)) %>% ungroup()
temp_col2 <- score_2020 %>% group_by(Region) %>% summarise(post_covid = mean(Life.Ladder)) %>% ungroup

temp_col2 <- temp_col2$post_covid[match(geo_covid$Region, temp_col2$Region)]
geo_covid$post_covid <- temp_col2

geo_covid <- geo_covid %>% pivot_longer(!Region, names_to = "year", values_to = "score")

geo_covid %>%
  hchart(., type = "column", 
       hcaes(x = Region, 
             y = score, 
             group = year)) %>% 
  hc_yAxis(opposite = FALSE) 
```

### Comparison between Development Level

```{r, fig.height=10, fig.width=15}
dev_covid <- ave1719 %>% group_by(Development.Level) %>% summarise(pre_covid = mean(Life.Ladder)) %>% ungroup()
temp_col3 <- score_2020 %>% group_by(Development.Level) %>% summarise(post_covid = mean(Life.Ladder)) %>% ungroup

temp_col3 <- temp_col3$post_covid[match(dev_covid$Development.Level, temp_col3$Development.Level)]
dev_covid$post_covid <- temp_col3
dev_covid$Development.Level <- replace(dev_covid$Development.Level, dev_covid$Development.Level == "#N/A", "Third World Countries")

dev_covid <- dev_covid %>% pivot_longer(!Development.Level, names_to = "year", values_to = "score")

dev_covid %>%
  hchart(., type = "column", 
       hcaes(x = Development.Level, 
             y = score, 
             group = year)) %>% 
  hc_yAxis(opposite = FALSE) 
```
## Happiness Score Rank Analysis

```{r, fig.height=10, fig.width=15}
library(ggalluvial)
allu <- read.csv("2015-2020.csv")

allu <- allu %>% mutate(Rank = factor(Rank, levels = c(1:50)))

ggplot(allu, aes(alluvium = Country.name, x = year, stratum = Rank, fill = Region)) +
  geom_alluvium(color = "blue") +
  geom_stratum(color = "black", fill = "light grey") +
  scale_fill_brewer(type = "qual", palette = "Paired") +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum)))) +
  ggtitle("Happiness Score Rank Movements")+
  geom_flow(stat = "alluvium", color = "black")

```
